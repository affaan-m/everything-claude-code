---
description: 要件を再確認し、リスクを評価し、ステップごとの実装計画を作成。コードに触れる前にユーザーの確認を待つ。
---

# Plan コマンド

このコマンドは **planner** エージェントを呼び出し、コードを書く前に包括的な実装計画を作成します。

## このコマンドの機能

1. **要件の再確認** - 構築すべきものを明確にする
2. **リスクの特定** - 潜在的な問題やブロッカーを洗い出す
3. **ステップ計画の作成** - 実装をフェーズに分割する
4. **確認を待つ** - 進行前にユーザーの承認を必ず得る

## 使用するタイミング

`/plan` を使用する場面：
- 新機能の開発を開始するとき
- 大規模なアーキテクチャ変更を行うとき
- 複雑なリファクタリングに取り組むとき
- 複数のファイルやコンポーネントに影響する変更があるとき
- 要件が不明確または曖昧なとき

## 動作の仕組み

planner エージェントは以下を行います：

1. **リクエストを分析** - 要件を明確な言葉で再確認する
2. **フェーズに分割** - 具体的で実行可能なステップに分ける
3. **依存関係を特定** - コンポーネント間の依存関係を明らかにする
4. **リスクを評価** - 潜在的なブロッカーを査定する
5. **複雑さを見積もる** - 高/中/低で評価する
6. **計画を提示** - 明示的な確認を待つ

## 使用例

```
User: /plan I need to add real-time notifications when markets resolve

Agent (planner):
# 実装計画：リアルタイムマーケット解決通知

## 要件の再確認
- ユーザーがウォッチしているマーケットが解決したときに通知を送信する
- 複数の通知チャネルに対応する（アプリ内、メール、webhook）
- 通知の確実な配信を保証する
- マーケットの結果とユーザーのポジション結果を含める

## 実装フェーズ

### フェーズ 1：データベーススキーマ
- notifications テーブルを追加（カラム：id, user_id, market_id, type, status, created_at）
- user_notification_preferences テーブルを追加（チャネル設定用）
- パフォーマンスのため user_id と market_id にインデックスを作成

### フェーズ 2：通知サービス
- lib/notifications.ts に通知サービスを作成
- BullMQ/Redis を使用した通知キューを実装
- 配信失敗時のリトライロジックを追加
- 通知テンプレートを作成

### フェーズ 3：統合ポイント
- マーケット解決ロジックにフックする（ステータスが "resolved" に変わったとき）
- マーケットにポジションを持つすべてのユーザーを検索
- 各ユーザーへの通知をキューに追加

### フェーズ 4：フロントエンドコンポーネント
- ヘッダーに NotificationBell コンポーネントを作成
- NotificationList モーダルを追加
- Supabase サブスクリプションによるリアルタイム更新を実装
- 通知設定ページを追加

## 依存関係
- Redis（キュー用）
- メールサービス（SendGrid/Resend）
- Supabase リアルタイムサブスクリプション

## リスク
- 高：メール到達性（SPF/DKIM が必要）
- 中：マーケットあたり1000人以上のユーザー時のパフォーマンス
- 中：マーケットが頻繁に解決する場合の通知スパム
- 低：リアルタイムサブスクリプションのオーバーヘッド

## 推定複雑さ：中
- バックエンド：4-6時間
- フロントエンド：3-4時間
- テスト：2-3時間
- 合計：9-13時間

**確認待ち**：この計画で進めますか？（yes/no/modify）
```

## 重要な注意事項

**重要**：planner エージェントは、ユーザーが "yes" や "proceed" などの肯定的な応答で明示的に計画を確認するまで、**コードを一切書きません**。

変更を希望する場合は、以下のように応答してください：
- "modify: [変更内容]"
- "different approach: [代替案]"
- "skip phase 2 and do phase 3 first"

## 他のコマンドとの連携

計画策定後：
- `/tdd` でテスト駆動開発による実装を行う
- `/build-and-fix` でビルドエラーが発生した場合に対応する
- `/code-review` で完成した実装をレビューする

## 関連エージェント

このコマンドは以下にある `planner` エージェントを呼び出します：
`~/.claude/agents/planner.md`
