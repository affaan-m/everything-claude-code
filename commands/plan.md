---
description: 要件を再述し、リスクを評価し、段階的な実装計画を作成する。コードに触れる前にユーザーの確認を待つ。
---

# Planコマンド

このコマンドは**planner**エージェントを呼び出して、コードを書く前に包括的な実装計画を作成します。

## このコマンドの機能

1. **要件の再述** - 何を構築する必要があるかを明確化
2. **リスクの特定** - 潜在的な問題とブロッカーを表面化
3. **段階的計画の作成** - 実装をフェーズに分解
4. **確認を待つ** - 進行前にユーザーの承認を受ける必要あり

## 使用するタイミング

`/plan`を使用する場合:

- 新しい機能を開始する
- 重要なアーキテクチャ変更を行う
- 複雑なリファクタリングに取り組む
- 複数のファイル/コンポーネントが影響を受ける
- 要件が不明確または曖昧

## 動作方法

plannerエージェントは:

1. リクエストを**分析**し、要件を明確な言葉で再述
2. 具体的で実行可能なステップで**フェーズに分解**
3. コンポーネント間の**依存関係を特定**
4. **リスク**と潜在的なブロッカーを評価
5. **複雑さを見積もり**（高/中/低）
6. 計画を**提示**し、明示的な確認を待つ

## 使用例

```
ユーザー: /plan マーケットが解決したときにリアルタイム通知を追加する必要がある

エージェント（planner）:

# 実装計画: リアルタイムマーケット解決通知

## 要件の再述

- ユーザーがウォッチしているマーケットが解決したときに通知を送信
- 複数の通知チャネルをサポート（アプリ内、メール、webhook）
- 通知が確実に配信されることを保証
- マーケット結果とユーザーのポジション結果を含める

## 実装フェーズ

### フェーズ1: データベーススキーマ

- notificationsテーブルを追加（列: id, user_id, market_id, type, status, created_at）
- チャネル設定用にuser_notification_preferencesテーブルを追加
- パフォーマンスのためにuser_idとmarket_idにインデックスを作成

### フェーズ2: 通知サービス

- lib/notifications.tsに通知サービスを作成
- BullMQ/Redisを使用した通知キューを実装
- 配信失敗時のリトライロジックを追加
- 通知テンプレートを作成

### フェーズ3: 統合ポイント

- マーケット解決ロジックにフック（ステータスが「resolved」に変更された時）
- マーケット内にポジションを持つすべてのユーザーをクエリ
- 各ユーザーに通知をエンキュー

### フェーズ4: フロントエンドコンポーネント

- ヘッダーにNotificationBellコンポーネントを作成
- NotificationListモーダルを追加
- Supabaseサブスクリプションによるリアルタイム更新を実装
- 通知設定ページを追加

## 依存関係

- Redis（キュー用）
- メールサービス（SendGrid/Resend）
- Supabaseリアルタイムサブスクリプション

## リスク

- 高: メール配信性（SPF/DKIM必須）
- 中: マーケットあたり1000人以上のユーザーでのパフォーマンス
- 中: マーケットが頻繁に解決する場合の通知スパム
- 低: リアルタイムサブスクリプションのオーバーヘッド

## 見積もり複雑さ: 中

- バックエンド: 4-6時間
- フロントエンド: 3-4時間
- テスト: 2-3時間
- 合計: 9-13時間

**確認待ち**: この計画で進めますか？（yes/no/modify）
```

## 重要な注意事項

**重要**: plannerエージェントは、「yes」や「proceed」などの肯定的な応答で明示的に計画を確認するまで、**コードを書きません**。

変更が必要な場合は、以下のように応答:

- "modify: [あなたの変更]"
- "different approach: [代替案]"
- "フェーズ2をスキップして先にフェーズ3を実行"

## 他のコマンドとの統合

計画後:

- `/tdd`を使用してテスト駆動開発で実装
- ビルドエラーが発生した場合は`/build-and-fix`を使用
- 完了した実装をレビューするには`/code-review`を使用

## 関連エージェント

このコマンドは以下の`planner`エージェントを呼び出します:
`~/.claude/agents/planner.md`
